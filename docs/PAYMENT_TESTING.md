# Руководство по тестированию интеграции с Tinkoff

## Обзор

Данное руководство описывает процесс тестирования интеграции с платежной системой Tinkoff для проекта TEXEX AI.

## Тестовые данные

### Конфигурация Tinkoff
- **Terminal Key**: 25801389
- **Merchant ID**: 200000001673251
- **Password**: Ut8FxLDYq2t3563u
- **API URL**: https://securepay.tinkoff.ru/v2/

### Тестовые карты Tinkoff

#### Успешные платежи
- **Номер карты**: 4300000000000777
- **Срок действия**: 12/24
- **CVV**: 123
- **Результат**: Успешный платеж

#### Ошибки платежей
- **Номер карты**: 4300000000000785
- **Срок действия**: 12/24
- **CVV**: 123
- **Результат**: Недостаточно средств

- **Номер карты**: 4300000000000793
- **Срок действия**: 12/24
- **CVV**: 123
- **Результат**: Отклонено банком

## Этапы тестирования

### 1. Тестирование генерации токенов

Перейдите на страницу `/payment/test` и выполните тест генерации токена:

1. Нажмите кнопку "Тестировать токен"
2. Убедитесь, что генерируется SHA-256 хеш длиной 64 символа
3. Проверьте, что токен генерируется корректно для разных параметров

**Ожидаемый результат**: Успешная генерация токена без ошибок.

### 2. Тестирование подключения к API

1. Нажмите кнопку "Тестировать API"
2. Проверьте, что запрос отправляется к Tinkoff API
3. Убедитесь, что возвращается корректный ответ с PaymentURL

**Ожидаемый результат**: 
```json
{
  "success": true,
  "paymentId": "12345678",
  "paymentUrl": "https://securepay.tinkoff.ru/..."
}
```

### 3. Тестирование полного цикла платежа

1. Настройте тестовый сервис (название, цену, описание)
2. Нажмите кнопку "Оплата" или "Рассрочка"
3. Убедитесь, что открывается модальное окно с индикатором загрузки
4. Проверьте, что открывается новое окно с платежной формой Tinkoff
5. Используйте тестовые карты для проверки различных сценариев

**Ожидаемый результат**: Успешное открытие платежной формы Tinkoff.

### 4. Тестирование обработки ошибок

#### Сетевые ошибки
1. Отключите интернет
2. Попробуйте инициировать платеж
3. Убедитесь, что показывается соответствующее сообщение об ошибке

#### Блокировка всплывающих окон
1. Включите блокировщик всплывающих окон в браузере
2. Попробуйте инициировать платеж
3. Убедитесь, что показывается сообщение о блокировке

#### Некорректные данные
1. Измените конфигурацию на некорректную (например, неверный Terminal Key)
2. Попробуйте инициировать платеж
3. Убедитесь, что показывается соответствующая ошибка

### 5. Тестирование страниц результата

#### Страница успеха
1. Перейдите на `/payment/success?OrderId=test123&PaymentId=456&Amount=100000&Status=CONFIRMED`
2. Убедитесь, что отображаются корректные данные платежа
3. Проверьте работу кнопок навигации

#### Страница ошибки
1. Перейдите на `/payment/error?OrderId=test123&ErrorCode=101&Message=Недостаточно средств`
2. Убедитесь, что отображается корректное сообщение об ошибке
3. Проверьте работу кнопок повтора и поддержки

## Автоматизированные тесты

### Запуск unit тестов
```bash
npm test
```

### Запуск интеграционных тестов
```bash
npm test -- --testPathPattern=paymentIntegration
```

### Покрытие тестами
```bash
npm test -- --coverage
```

## Чек-лист тестирования

### Функциональность
- [ ] Генерация токенов работает корректно
- [ ] API запросы отправляются с правильными параметрами
- [ ] Платежная форма открывается в новом окне
- [ ] Модальные окна отображаются корректно
- [ ] Обработка ошибок работает правильно
- [ ] Страницы успеха и ошибки отображают корректную информацию

### Безопасность
- [ ] Пароль не передается в открытом виде
- [ ] Токены генерируются согласно документации Tinkoff
- [ ] Чувствительные данные не логируются в консоль
- [ ] HTTPS используется для всех запросов

### UX/UI
- [ ] Кнопки оплаты отображаются корректно на всех устройствах
- [ ] Состояния загрузки показываются пользователю
- [ ] Сообщения об ошибках понятны пользователю
- [ ] Навигация работает корректно

### Производительность
- [ ] Время инициализации платежа не превышает 5 секунд
- [ ] Retry логика работает для сетевых ошибок
- [ ] Таймауты настроены корректно

## Известные проблемы и ограничения

1. **Тестовая среда**: Используются реальные идентификаторы Tinkoff, но в тестовом режиме
2. **CORS**: Возможны проблемы с CORS при локальной разработке
3. **Всплывающие окна**: Некоторые браузеры могут блокировать всплывающие окна по умолчанию

## Контакты для поддержки

- **Техническая поддержка**: https://t.me/ruhunt
- **Документация Tinkoff**: https://www.tinkoff.ru/kassa/dev/
- **API Reference**: https://www.tinkoff.ru/kassa/dev/payments/

## Логирование и мониторинг

Все ошибки платежей логируются в консоль браузера с подробной информацией:
- Код ошибки
- Сообщение для пользователя
- Контекст (ID заказа, сумма, и т.д.)
- Временная метка
- User Agent и URL

В продакшене рекомендуется настроить отправку логов в систему мониторинга (Sentry, LogRocket и т.д.).